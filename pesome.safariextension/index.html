<html>
<head>
<link href="http://twitter.github.com/bootstrap/assets/css/bootstrap.css" rel="stylesheet">
<link href="http://twitter.github.com/bootstrap/assets/css/bootstrap-responsive.css" rel="stylesheet">
<link href="select2.css" rel="stylesheet">

<script src="jquery-1.7.1.min.js"></script>
<script src="select2.js"></script>



<title>Afterclassroom</title>
</head>




  <body>

<div class="container" id="main_panel">
</div>

<script type="text/javascript">
//var URL = 'http://localhost:3000';
var URL = 'http://dev.afterclassroom.com';
//var URL = 'http://pesome.com';

var activeUrl;

function InitPopover(){
	activeUrl = safari.application.activeBrowserWindow.activeTab.url

	$.ajax({
		url: URL + '/extensions/attach_link?link='+activeUrl,
		type: 'GET',
		dataType: 'html',
		data: {
		},
		success: function(html){
			$('#main_panel').html(html);
			SignInHandler();
			safari.extension.toolbarItems[0].showPopover();
		},
		error: function(er){
			$('#main_panel').html('Operation Failed. Please try again.');
		}
	});



}

function SignInHandler(){
	var params_arr = [];
	var str_action = $('#main_panel').find('#form_signin').attr('action');
	params_arr.push(str_action);

	$('#main_panel').find('.btn-signin').click(function(){
		params_arr.push($('#main_panel').find('#user_email').val());
		params_arr.push($('#main_panel').find('#user_password').val());
		$('#main_panel').html('PLEASE WAIT...');
		SubmitSignIn(params_arr);
	});
}

function SubmitSignIn(params_arr){
		$('#main_panel').html('PLEASE WAIT...');
		$.ajax({
			url: params_arr[0],
			type: 'POST',
			dataType: 'html',
            data: {
                user: {
                    email: params_arr[1],
                    password: params_arr[2]
                },
                link: activeUrl
            },
            success: function(html){
				$('#main_panel').html(html);

				if ( $('#main_panel').find('#flash_error').html() == "Invalid email or password."             ){
					SignInHandler();
				}
				else{
					AttachLinkHandler();
				}
			},
			error: function(er){
				$('#main_panel').html('Operation Failed. Please try again.');
			}
		});
}

function AttachLinkHandler(){
	if ($('#main_panel').find("#tags").length > 0) {
		$('#main_panel').find("#tags").select2({
			tags : $('#main_panel').find('#tag_list').val().split(',')
		});
	}
}

</script>


  </body>
</html>
